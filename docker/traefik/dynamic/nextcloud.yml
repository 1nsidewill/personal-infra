# Nextcloud AIO Traefik ë™ì  ë¼ìš°íŒ…
# ì°¸ì¡°: https://github.com/techworks-id/nextcloud_aio-traefik
# 
# Failover êµ¬ì¡°:
# 1. nextcloud-aio-domaincheck (ì„¤ì •/ê²€ì¦) â†’ 2. nextcloud-aio-apache (ì‹¤ì œ ì›¹ì„œë²„)

http:
  routers:
    # ===========================================
    # ğŸŒ Nextcloud ë©”ì¸ ë¼ìš°í„° (HTTPS)
    # ===========================================
    nextcloud:
      rule: "Host(`nextcloud.insidewill.site`)"
      entrypoints:
        - "websecure"
      service: nextcloud
      middlewares:
        - nc-chain
      tls:
        certresolver: "letsencrypt"
        
    # ===========================================
    # ğŸ”„ HTTP â†’ HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸
    # ===========================================
    nextcloud-http:
      rule: "Host(`nextcloud.insidewill.site`)"
      entrypoints:
        - "web"
      middlewares:
        - https-redirect
      service: nextcloud

  # ===========================================
  # ğŸ¯ ì„œë¹„ìŠ¤ ì •ì˜ (Failover êµ¬ì¡°)
  # ===========================================
  services:
    # ë©”ì¸ ì„œë¹„ìŠ¤ (Failover ì§€ì›)
    nextcloud:
      failover:
        service: nc_setup      # 1ì°¨: ë„ë©”ì¸ ê²€ì¦/ì„¤ì •
        fallback: nc_run       # 2ì°¨: ì‹¤ì œ ì›¹ì„œë²„
        
    # 1ì°¨ ì„œë¹„ìŠ¤: ë„ë©”ì¸ ê²€ì¦ & ì´ˆê¸° ì„¤ì •
    nc_setup:
      loadBalancer:
        healthCheck:
          path: /
          interval: 5s
          timeout: 2s
        servers:
          - url: "http://nextcloud-aio-domaincheck:11000"
        passHostHeader: true
        
    # 2ì°¨ ì„œë¹„ìŠ¤: ì‹¤ì œ Nextcloud ì›¹ì„œë²„
    nc_run:
      loadBalancer:
        servers:
          - url: "http://nextcloud-aio-apache:11000"
        passHostHeader: true

  # ===========================================
  # ğŸ›¡ï¸ ë¯¸ë“¤ì›¨ì–´ ì •ì˜
  # ===========================================
  middlewares:
    # HTTPS ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    https-redirect:
      redirectscheme:
        scheme: "https"
        permanent: true
        
    # Nextcloud ë³´ì•ˆ í—¤ë”
    nc-secure-headers:
      headers:
        # í”„ë¡ì‹œ í—¤ë” ì„¤ì •
        hostsProxyHeaders:
          - "X-Forwarded-Host"
          - "X-Forwarded-Proto"
          - "X-Forwarded-For"
          - "X-Real-IP"
        
        # ì»¤ìŠ¤í…€ ìš”ì²­ í—¤ë”
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Real-IP: ""
          
        # ë³´ì•ˆ ì‘ë‹µ í—¤ë”
        customResponseHeaders:
          # ê²€ìƒ‰ ì—”ì§„ ì°¨ë‹¨
          X-Robots-Tag: "noindex, nofollow"
          # ë³´ì•ˆ í—¤ë”ë“¤
          Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "SAMEORIGIN"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
          
        # ê¸°ë³¸ ë³´ì•ˆ ì •ì±…
        referrerPolicy: "same-origin"
        
    # ë¯¸ë“¤ì›¨ì–´ ì²´ì¸ (ìˆœì„œ ì¤‘ìš”!)
    nc-chain:
      chain:
        middlewares:
          - https-redirect
          - nc-secure-headers 