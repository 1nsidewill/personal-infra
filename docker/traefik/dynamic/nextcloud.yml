# Nextcloud AIO Traefik ë™ì  ë¼ìš°íŒ… (ì»¨í…Œì´ë„ˆ ë°©ì‹)
# ì°¸ì¡°: https://github.com/techworks-id/nextcloud_aio-traefik
# 
# Traefikê³¼ AIOê°€ ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ì— ìˆìœ¼ë¯€ë¡œ ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ ì ‘ê·¼

http:
  routers:
    # ===========================================
    # ğŸŒ Nextcloud ë©”ì¸ ë¼ìš°í„° (HTTPS)
    # ===========================================
    nextcloud:
      rule: "Host(`nextcloud.insidewill.site`)"
      entrypoints:
        - "websecure"
      service: nextcloud-service
      middlewares:
        - nc-chain
      tls:
        certresolver: "letsencrypt"
        
    # ===========================================
    # ğŸ”„ HTTP â†’ HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸
    # ===========================================
    nextcloud-http:
      rule: "Host(`nextcloud.insidewill.site`)"
      entrypoints:
        - "web"
      middlewares:
        - https-redirect
      service: nextcloud-service

  # ===========================================
  # ğŸ¯ ì„œë¹„ìŠ¤ ì •ì˜ (ì»¨í…Œì´ë„ˆ ë°©ì‹)
  # ===========================================
  services:
    # AIO Apache ì„œë¹„ìŠ¤ (ì»¨í…Œì´ë„ˆ ì´ë¦„ ì‚¬ìš©)
    nextcloud-service:
      loadBalancer:
        servers:
          - url: "http://nextcloud-aio-apache:11000"
        passHostHeader: true

  # ===========================================
  # ğŸ›¡ï¸ ë¯¸ë“¤ì›¨ì–´ ì •ì˜
  # ===========================================
  middlewares:
    # HTTPS ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    https-redirect:
      redirectscheme:
        scheme: "https"
        permanent: true
        
    # Nextcloud ë³´ì•ˆ í—¤ë”
    nc-secure-headers:
      headers:
        # í”„ë¡ì‹œ í—¤ë” ì„¤ì •
        hostsProxyHeaders:
          - "X-Forwarded-Host"
          - "X-Forwarded-Proto"
          - "X-Forwarded-For"
          - "X-Real-IP"
        
        # ì»¤ìŠ¤í…€ ìš”ì²­ í—¤ë”
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Real-IP: ""
          
        # ë³´ì•ˆ ì‘ë‹µ í—¤ë”
        customResponseHeaders:
          # ê²€ìƒ‰ ì—”ì§„ ì°¨ë‹¨
          X-Robots-Tag: "noindex, nofollow"
          # ë³´ì•ˆ í—¤ë”ë“¤
          Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "SAMEORIGIN"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
          
        # ê¸°ë³¸ ë³´ì•ˆ ì •ì±…
        referrerPolicy: "same-origin"
        
    # ë¯¸ë“¤ì›¨ì–´ ì²´ì¸ (ìˆœì„œ ì¤‘ìš”!)
    nc-chain:
      chain:
        middlewares:
          - https-redirect
          - nc-secure-headers 