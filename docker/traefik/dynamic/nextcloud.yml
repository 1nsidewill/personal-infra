http:
  routers:
    # Nextcloud 메인 라우터
    nextcloud:
      rule: "Host(`your-nextcloud-domain.com`)"
      entrypoints:
        - "websecure"
      service: nextcloud
      middlewares:
        - nextcloud-chain
      tls:
        certresolver: "letsencrypt"
    
    # HTTP에서 HTTPS로 리다이렉트
    nextcloud-http:
      rule: "Host(`your-nextcloud-domain.com`)"
      entrypoints:
        - "web"
      middlewares:
        - https-redirect
      service: nextcloud

  services:
    nextcloud:
      loadBalancer:
        servers:
          - url: "http://172.30.1.42:11000"

  middlewares:
    # HTTPS 리다이렉트
    https-redirect:
      redirectscheme:
        scheme: https
        permanent: true

    # 보안 헤더들
    nextcloud-secure-headers:
      headers:
        hostsProxyHeaders:
          - "X-Forwarded-Host"
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Real-IP: ""
        customResponseHeaders:
          Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "SAMEORIGIN"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
        referrerPolicy: "same-origin"

    # 미들웨어 체인
    nextcloud-chain:
      chain:
        middlewares:
          - https-redirect
          - nextcloud-secure-headers 