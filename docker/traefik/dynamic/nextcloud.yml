# Nextcloud AIO Traefik 동적 라우팅 (Host IP 방식)
# 참조: https://github.com/techworks-id/nextcloud_aio-traefik
# 
# AIO가 bridge 네트워크를 사용하므로 호스트 IP로 접근

http:
  routers:
    # ===========================================
    # 🌐 Nextcloud 메인 라우터 (HTTPS)
    # ===========================================
    nextcloud:
      rule: "Host(`nextcloud.insidewill.site`)"
      entrypoints:
        - "websecure"
      service: nextcloud-service
      middlewares:
        - nc-chain
      tls:
        certresolver: "letsencrypt"
        
    # ===========================================
    # 🔄 HTTP → HTTPS 리다이렉트
    # ===========================================
    nextcloud-http:
      rule: "Host(`nextcloud.insidewill.site`)"
      entrypoints:
        - "web"
      middlewares:
        - https-redirect
      service: nextcloud-service

  # ===========================================
  # 🎯 서비스 정의 (Host IP 방식)
  # ===========================================
  services:
    # AIO Apache 서비스 (포트 11000)
    nextcloud-service:
      loadBalancer:
        servers:
          - url: "http://172.30.1.42:11000"
        passHostHeader: true

  # ===========================================
  # 🛡️ 미들웨어 정의
  # ===========================================
  middlewares:
    # HTTPS 강제 리다이렉트
    https-redirect:
      redirectscheme:
        scheme: "https"
        permanent: true
        
    # Nextcloud 보안 헤더
    nc-secure-headers:
      headers:
        # 프록시 헤더 설정
        hostsProxyHeaders:
          - "X-Forwarded-Host"
          - "X-Forwarded-Proto"
          - "X-Forwarded-For"
          - "X-Real-IP"
        
        # 커스텀 요청 헤더
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Real-IP: ""
          
        # 보안 응답 헤더
        customResponseHeaders:
          # 검색 엔진 차단
          X-Robots-Tag: "noindex, nofollow"
          # 보안 헤더들
          Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "SAMEORIGIN"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
          
        # 기본 보안 정책
        referrerPolicy: "same-origin"
        
    # 미들웨어 체인 (순서 중요!)
    nc-chain:
      chain:
        middlewares:
          - https-redirect
          - nc-secure-headers 